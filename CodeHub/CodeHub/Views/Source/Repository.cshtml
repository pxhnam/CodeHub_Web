
@{
    ViewBag.Title = "Source";
}

<div class="row">
    <div class="col-12 py-5 d-flex justify-content-between align-items-center">
        <h4>Mã Nguồn</h4>
        <button type="button" class="btn btn-primary" id="btnCreate">Thêm</button>
    </div>
</div>
<div class="row table-bordered">
    <div class="col-lg-12">
        <div class="grid">
            <p class="grid-header">Danh sách mã nguồn</p>
            <div class="item-wrapper">
                <div class="table-responsive">
                    <div class="form-filter d-flex"></div>
                        <div class="form-group mr-3">
                            <label for="selectLanguage">Ngôn ngữ lập trình: </label>
                            <select id="selectLanguage" class="form-control custom-select" name="LanguageID" style="width:120px">
                                <option value="0" selected>Tất cả</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="selectType">Thể loại: </label>
                            <select id="selectType" class="form-control custom-select" name="TypeID" style="width:120px">
                                <option value="0" selected>Tất cả</option>
                            </select>
                        </div>
                    
                    <div class="form-group" style="max-width:300px">
                        <label for="inputSearch">Tìm kiếm</label>
                        <input type="text" class="form-control" id="inputSearch" placeholder="Nhập từ khóa...">
                    </div>
                    <table class="table info-table table-bordered">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Image</th>
                                <th>Video</th>
                                <th>Thẻ</th>
                                <th>Ngôn ngữ</th>
                                <th>Phí</th>
                                <th>Link</th>
                                <th>Người đăng</th>
                                <th>Tình trạng</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="d-flex justify-content-center align-items-center py-5">
                <nav aria-label="Page navigation">
                    <ul class="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script type="text/javascript">
        var typingTimer;
        const inputSearch = $('#inputSearch');
        const language = $('#selectLanguage');
        const type = $('#selectType');
        var saveID;
        var currentPage = 1;
        $(document).ready(function () {
            insertSelect('@Url.Action("getTypes", "API")', type);
            insertSelect('@Url.Action("getLanguages", "API")', language);
            loadData(inputSearch.val(), type.val(), language.val(), currentPage);
        });
        $('#btnCreate').on('click', () => {
            window.location.href = '@Url.Action("UploadCode", "Source")';
        })

        
        $(document).on('click', '#btnChange', function () {
            let $this = $(this);
            $.ajax({
                url: '/API/changeShow',
                type: 'POST',
                data: { id: $this.closest('tr').data('id') },
                success: function (res) {
                    if (res.success) {
                        $this.toggleClass('btn-inverse-success btn-inverse-danger');
                        $this.text((_, text) => {
                            return text === 'Hiện' ? 'Ẩn' : 'Hiện';
                        });
                    }
                }
            })
        });
        $(document).on('click', '#btnEdit', function () {
            window.location.href = '@Url.Action("UploadCode", "Source")' + '?id=' + $(this).closest('tr').data('id');
        });

        language.change(function () {
            loadData(inputSearch.val(), type.val(), language.val(), currentPage);
        });

        type.change(function () {
            loadData(inputSearch.val(), type.val(), language.val(), currentPage);
        });

        function loadData(search, type, language, page) {
            $('tbody').empty();
            $.ajax({
                url: '@Url.Action("getSources", "API")',
                type: 'POST',
                data: { search, type, language, page },
                success: function (res) {
                    if (res.success) {
                        $('.table-responsive').find('.text-notification').remove();
                        $('.pagination').empty();
                        if (res.list.length > 0) {
                            $.each(res.list, (index, item) => {
                                $('tbody').append(columnInTable(
                                    item.ID,
                                    item.Name,
                                    item.image,
                                    item.LinkVideo,
                                    item.TypeName,
                                    item.LanguageName,
                                    item.Fee,
                                    item.SourceLink,
                                    item.Username,
                                    item.IsShow,
                                ));
                            });
                            if (res.numPage > 1) {
                                for (i = 1; i <= res.numPage; i++) {
                                    $('.pagination').append(`<li class="page-item${i == currentPage ? ' active' : ' '}"><a class="page-link" href="#">${i}</a></li>`);
                                }
                            }
                        } else {
                            $('.table-responsive').append(`<p class="text-center text-notification">Không tìm thấy !</p>`)
                        }
                    } else {
                    }
                }
            })
        }
        function insertSelect(url, target) {
            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    search: '',
                    page: 0
                },
                success: function (res) {
                    if (res.success) {
                        $.each(res.list, function (index, value) {
                            target.append(`<option value="${value.ID}">${value.Name}</option>`);
                        })
                    } else { }
                }
            });
        }
        inputSearch.on('input', function () {
            currentPage = 1;
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                loadData(inputSearch.val(), type.val(), language.val(), currentPage);
            }, 500);
        });
        $('.pagination').on('click', 'li', function (e) {
            e.preventDefault();
            currentPage = $(this).text();
            loadData(inputSearch.val(), type.val(), language.val(), currentPage);
         })
        $(document).on('click', '#btnRemove', function () {
            let getName = $(this).closest('tr').find('td:eq(1)').text();
            saveID = $(this).closest('tr').data('id');
            createModal('Xóa Source Code', `Bạn có chắc chắn muốn xóa '${getName}' không?`, 'Xóa', 'Hủy');
        })
        $(document).on('click', '#btnOk', function () {
            process(true)
            $.ajax({
                url: '/API/removeSource',
                type: 'POST',
                data: { id: saveID },
                success: function (res) {
                    if (res.success) {
                        loadData(inputSearch.val(), type.val(), language.val(), currentPage);
                        $('#staticBackdrop').modal('hide');
                    } else {
                        process(false, 'Xóa');
                    }
                }
            })
        })
        function createModal(title, content, ok, cancel) {
            $('.modal-title').text(title);
            $('.modal-body').empty().append(content);
            $('#btnOk').removeClass('disabled')
            $('#btnOk').text(ok).addClass('btn-danger');
            $('#btnCancel').removeClass('disabled')
            $('#btnCancel').text(cancel);
        }
        function process(isLoad, text) {
            if (isLoad) {
                $('#btnOk').empty().addClass('disabled').append('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
                $('#btnCancel').addClass('disabled')
            } else {
                $('#btnOk').empty().removeClass('disabled').text(text)
                $('#btnCancel').removeClass('disabled')
            }
        }
        function changeRow(id, name) {
            $(`tr[data-id='${id}']`).find("td.name-language").text(name);
        }
        function columnInTable(id, name, image, video, type, language, fee, source, user, status) {
            return `<tr data-id='${id}'>
                        <td>${name}</td>
                        <td><a href="${image}" target="_blank">Hình</a></td>
                        <td><a href="${video}" target="_blank">Video</a></td>
                        <td>${type}</td>
                        <td>${language}</td>
                        <td>${fee}</td>
                        <td><a href="${source}" target="_blank">Tải</a></td>
                        <td>${user}</td>
                        <td>
                            <button id="btnChange" type="button" class="btn btn-inverse-${status == 1 ? 'success' : 'danger'} btn-xs">${status == 1 ? 'Hiện' : 'Ẩn' }</button>
                        </td>
                        <td class="actions" style="padding:0">
                            <button type="button"
                                    id="btnEdit"
                                    class="btn btn-rounded social-icon-btn btn-inverse-success">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                            <button type="button"
                                    id="btnRemove"
                                    class="btn btn-rounded social-icon-btn btn-inverse-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#staticBackdrop">
                                <i class="mdi mdi-delete"></i>
                            </button>
                        </td>
                    </tr>`;
        }
    </script>
}